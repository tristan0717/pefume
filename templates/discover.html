<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discover â€“ Daily Perfume</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    :root{ --accent:#b99ad6; }

    html,body{ height:auto; overflow-y:auto; } /* í˜ì´ì§€ ìŠ¤í¬ë¡¤ í—ˆìš© */

    .discover-shell{width:min(1100px,92vw);margin:0 auto; padding-top:20px;}
    .feed__tip{ background:#fff; border-radius:12px; padding:12px; color:#6f6a63; font-size:13px; margin-bottom:8px; }

    /* ===== íƒ€ì„ë¼ì¸(ëŒ€í™”ì²˜ëŸ¼ ìœ„â†’ì•„ë˜ë¡œ ìŒ“ì„) ===== */
    .chat-feed{
      display:flex; flex-direction:column; gap:18px;
      padding:18px 0 140px;   /* ê³ ì • í”„ë¡¬í”„íŠ¸ ê³µê°„ë§Œí¼ í•˜ë‹¨ ì—¬ë°± */
    }

    /* ì‚¬ìš©ì ë§í’ì„ (ì˜¤ë¥¸ìª½) */
    .msg.user{
      align-self:flex-end; max-width:65%;
      background:var(--accent); color:#fff;
      border-radius:16px; padding:10px 14px;
      box-shadow:0 6px 16px rgba(185,154,214,.25);
      opacity:0; transform:translateY(8px);
      animation:fadeIn .28s ease forwards;
      font-size:15px; line-height:1.45;
    }

    /* ì‹œìŠ¤í…œ ë¸”ë¡(ì™¼ìª½) : ì¶”ì²œ/AI ì¹´ë“œ ì»¨í…Œì´ë„ˆ */
    .msg.ai{
      align-self:flex-start; width:min(880px, 92vw);
      display:flex; flex-direction:column; gap:10px;
      opacity:0; transform:translateY(8px);
      animation:fadeIn .28s ease forwards;
    }
    .msg.ai .card-list{ display:flex; flex-direction:column; gap:14px; }
    .msg.ai .perf-card{ border:none; padding:0; margin:0; }  /* ì ì„ /í…Œë‘ë¦¬ ì œê±° */
    .msg.ai .perf-title{ margin:0; }

    /* ë”ë³´ê¸°/ì ‘ê¸° ë²„íŠ¼ */
    .load-more{
      align-self:flex-start;
      appearance:none; cursor:pointer;
      border:1px solid #dcd6cf; background:#fff; color:#6b6056;
      font-weight:700; font-size:14px; padding:10px 16px; border-radius:12px;
      transition:transform .15s, box-shadow .2s, border-color .2s, color .2s;
    }
    .load-more:hover{
      transform:translateY(-1px);
      border-color:var(--accent); color:#4d3a67; box-shadow:0 10px 28px rgba(0,0,0,.08);
    }
    .load-more--ghost{
      background: transparent;
      border: 1px solid #e6e0d9;
      color: #8a7b6d;
    }
    .load-more--ghost:hover{
      border-color: var(--accent);
      color:#4d3a67;
      box-shadow: 0 10px 28px rgba(0,0,0,.08);
    }

    /* ê³ ì • í”„ë¡¬í”„íŠ¸ ë°” */
    .prompt-bar{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:#fff; border-top:1px solid var(--border);
      box-shadow:0 -8px 24px rgba(0,0,0,.04);
      padding:12px clamp(14px, 4vw, 24px) calc(12px + env(safe-area-inset-bottom));
    }
    .prompt-inner{width:min(1100px,92vw); margin:0 auto; display:flex; gap:8px;}
    .prompt-inner input{
      flex:1 1 auto; min-width:200px;
      border:1px solid var(--border); border-radius:12px;
      padding:12px 14px; outline:none; background:#fff; color:#232323;
    }
    .prompt-inner button.btn--primary{
      background:#111; color:#fff; border:none; border-radius:12px;
      padding:12px 16px; font-weight:700;
    }
    .prompt-inner button.btn--primary:hover{background:#333; transform:translateY(-1px);}

    /* ë…¸íŠ¸ íŒì—…(ìŠ¤í¬ë¦½íŠ¸ ìœ í‹¸ê³¼ ë™ì¼ ìŠ¤íƒ€ì¼) */
    .note-pop{
      position:fixed; display:none; background:#fff; border:1px solid #ddd;
      border-radius:12px; padding:12px 16px; z-index:3000;
      box-shadow:0 8px 24px rgba(0,0,0,.12); max-width:320px; color:#222; line-height:1.4;
    }
    .note-section{margin-bottom:10px;}
    .note-title{font-weight:700; margin-bottom:4px; font-size:14px;}
    .note-line{display:flex; flex-wrap:wrap; gap:8px;}
    .note-card{display:flex; flex-direction:column; align-items:center; width:80px;}
    .note-card img.note-img{width:60px; height:60px; border-radius:8px; object-fit:cover;}
    .note-name{font-size:12px; color:#333; margin-top:4px; text-align:center;}

    @keyframes fadeIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
  </style>
</head>

<body>
  <nav class="nav">
    <div class="nav__left">
      <a class="brand brand--dot" href="{{ url_for('recommend.home') }}">Daily Perfume</a>
    </div>
  </nav>

  <main class="discover-shell">
    <div class="feed__tip">
      ğŸ’¡ ì›í•˜ëŠ” ë¶„ìœ„ê¸°ë‚˜ ìš©ë„ë¥¼ ìì—°ì–´ë¡œ ì…ë ¥í•´ ë³´ì„¸ìš”. ì˜ˆ)
      <em>â€œë¹„ ì˜¤ëŠ” ë‚  í¬ê·¼í•œ ë¨¸ìŠ¤í¬â€, â€œì¶œê·¼ìš© ìƒí¼í•œ ì‹œíŠ¸ëŸ¬ìŠ¤, ì”í–¥ì€ ê¹¨ë—í•˜ê²Œâ€</em>
    </div>

    <!-- ëŒ€í™”ì²˜ëŸ¼ ëˆ„ì ë˜ëŠ” íƒ€ì„ë¼ì¸ -->
    <div id="chatFeed" class="chat-feed"></div>
  </main>

  <!-- ê³ ì • í”„ë¡¬í”„íŠ¸ -->
  <form class="prompt-bar" id="promptForm">
    <div class="prompt-inner">
      <input id="promptInput" type="text" placeholder="ì›í•˜ëŠ” í–¥ì„ ë¬¸ì¥ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”â€¦" autocomplete="off" />
      <button class="btn btn--primary" type="submit">ê²€ìƒ‰</button>
    </div>
  </form>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div class="loading-overlay" id="loading-overlay" style="display:none;">
    <div class="spinner"></div>
    <p style="color:#fff">ì¶”ì²œ ìƒì„± ì¤‘â€¦</p>
  </div>

  <!-- íŒì—… ì»¨í…Œì´ë„ˆ (script.jsì—ì„œ ì‚¬ìš©) -->
  <div class="note-pop note-pop--plain" style="display:none;"></div>

  <!-- ê¸°ì¡´ ì „ì—­ ìœ í‹¸(íŒì—…/íŒŒì„œ ë“± í¬í•¨) -->
  <script src="{{ url_for('static', filename='script.js') }}"></script>

  <script>
    // ========= ìœ í‹¸ =========
    const chat = document.getElementById('chatFeed');
    let msgSeq = 0;
    function scrollToBottom(){ window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' }); }

    // ì‚¬ìš©ì ë§í’ì„  ì¶”ê°€
    function addUserBubble(text){
      const el = document.createElement('div');
      el.className = 'msg user';
      el.textContent = text;
      chat.appendChild(el);
      scrollToBottom();
    }

    // âœ… ë”ë³´ê¸°/ì ‘ê¸° í† ê¸€ì´ ìˆëŠ” ì¶”ì²œ ê²°ê³¼ ë©”ì‹œì§€(ì™¼ìª½)
    function addRecMessage(results){
      const wrap = document.createElement('div');
      wrap.className = 'msg ai';

      const listId     = `recList_msg_${++msgSeq}`;
      const moreId     = `loadMore_msg_${msgSeq}`;
      const collapseId = `collapse_msg_${msgSeq}`;

      wrap.innerHTML = `
        <div class="card-list" id="${listId}"></div>
        <div style="display:flex; gap:8px;">
          <button class="load-more" id="${moreId}" type="button">ë”ë³´ê¸°</button>
          <button class="load-more load-more--ghost" id="${collapseId}" type="button" style="display:none;">ì ‘ê¸°</button>
        </div>
      `;
      chat.appendChild(wrap);

      const list    = wrap.querySelector('#' + listId);
      const btnMore = wrap.querySelector('#' + moreId);
      const btnCol  = wrap.querySelector('#' + collapseId);

      const all = Array.isArray(results) ? results : [];
      let shown = 0;

      // ë¦¬ìŠ¤íŠ¸ë¥¼ countê°œê¹Œì§€ë§Œ ë‹¤ì‹œ ê·¸ë ¤ì¤Œ (ë”ë³´ê¸°/ì ‘ê¸° ê³µí†µ ë¡œì§)
      function render(count){
        list.innerHTML = '';
        const slice = all.slice(0, count);

        slice.forEach(p=>{
          const brand = p.Brand || p.brand || "Unknown";
          const name  = p.Name  || p.name  || "Untitled";
          const year  = (p.Year ?? p.year ?? "") || "";
          const noteRaw = p.Note || p.note || "";
          const notes = parseNotes(noteRaw);

          const popHTML = (notes.top.length || notes.middle.length || notes.base.length)
            ? (noteRows("Top Notes", notes.top)
              + noteRows("Middle Notes", notes.middle)
              + noteRows("Base Notes", notes.base))
            : noteRows("Notes", notes.flat);

          const card = document.createElement('div');
          card.className = 'perf-card perf-card--compact';
          card.innerHTML = `
            <div class="perf-title">
              <a href="javascript:void(0)" class="hover-note" data-pop='${encodeURIComponent(popHTML)}'>${brand}</a>
              &nbsp;â€”&nbsp;
              <a href="javascript:void(0)" class="hover-note" data-pop='${encodeURIComponent(popHTML)}'>${name}</a>
              ${year ? ` <span class="perf-meta">(${year})</span>` : ""}
            </div>
          `;

          card.querySelectorAll('.hover-note').forEach(a=>{
            a.addEventListener('mouseenter', ev=>{
              const html = decodeURIComponent(a.dataset.pop || "");
              if (html.trim()) showPop(html, ev.clientX, ev.clientY);
            });
            a.addEventListener('mousemove', ev=>{
              if (_pop.style.display === "block") {
                showPop(_pop.innerHTML, ev.clientX, ev.clientY);
              }
            });
            a.addEventListener('mouseleave', hidePop);
          });

          list.appendChild(card);
        });

        shown = slice.length;

        // ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ê°±ì‹ 
        btnMore.style.display = (shown < all.length) ? 'inline-block' : 'none';
        btnCol.style.display  = (shown > 5) ? 'inline-block' : 'none';

        scrollToBottom();
      }

      // ì´ˆê¸° 5ê°œë§Œ ì¶œë ¥
      render(Math.min(5, all.length));

      // ë”ë³´ê¸°: +5ê°œ
      btnMore.addEventListener('click', ()=>{
        render(Math.min(shown + 5, all.length));
      });

      // ì ‘ê¸°: í•­ìƒ 5ê°œë¡œ ì¶•ì†Œ
      btnCol.addEventListener('click', ()=>{
        render(Math.min(5, all.length));
      });
    }

    // AI í–¥ìˆ˜ ì œì•ˆ ë©”ì‹œì§€(ì™¼ìª½, ëˆ„ì )
    function addAiMessage(objOrRaw){
      const wrap = document.createElement('div');
      wrap.className = 'msg ai';
      if(typeof objOrRaw === 'string'){
        wrap.innerHTML = `<div class="ai-card">${objOrRaw}</div>`;
      }else{
        const safe = a => Array.isArray(a)? a.join(", ") : "";
        wrap.innerHTML = `
          <div class="ai-card">
            <div class="ai-title" style="font-weight:800; font-size:18px;">${objOrRaw.name || "Untitled"}</div>
            <div class="ai-meta" style="color:#8f8278; font-size:13px;">
              ${objOrRaw.category ? `ì¹´í…Œê³ ë¦¬: ${objOrRaw.category}`:""}${objOrRaw.mood? ` Â· ë¬´ë“œ: ${objOrRaw.mood}`:""}
            </div>
            <div class="ai-notes" style="margin-top:6px;">
              ${objOrRaw.top? `<div><strong>Top</strong> â€” ${safe(objOrRaw.top)}</div>`:""}
              ${objOrRaw.middle? `<div><strong>Middle</strong> â€” ${safe(objOrRaw.middle)}</div>`:""}
              ${objOrRaw.base? `<div><strong>Base</strong> â€” ${safe(objOrRaw.base)}</div>`:""}
            </div>
            ${objOrRaw.description? `<p class="ai-desc" style="margin-top:8px;">${objOrRaw.description}</p>`:""}
          </div>
        `;
      }
      chat.appendChild(wrap);
      scrollToBottom();
    }

    // ========= í”„ë¡¬í”„íŠ¸ íë¦„ =========
    const form  = document.getElementById('promptForm');
    const input = document.getElementById('promptInput');

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = input.value.trim();
      if(!q) return;
      addUserBubble(q);
      input.value = "";

      if(!navigator.geolocation){
        requestAndRender(q, null, null);
      }else{
        navigator.geolocation.getCurrentPosition(
          pos => requestAndRender(q, pos.coords.latitude, pos.coords.longitude),
          _   => requestAndRender(q, null, null)
        );
      }
    });

    function requestAndRender(query, lat, lon){
      showLoading();
      fetch("/recommend", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ query, lat, lon })
      })
      .then(r=>r.text())
      .then(txt=>{
        const data = JSON.parse(txt.replace(/\bNaN\b/g,"null"));
        addRecMessage(data.response || []);

        // AI í–¥ìˆ˜ ì œì•ˆë„ ëˆ„ì 
        const notes = (data.response || []).map(p=>p.Note || p.note || '');
        return fetch("/generate-custom-fragrance",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ user_cat:query, user_note:query, weather:data.weather_description || "", notes })
        });
      })
      .then(r=>r.json())
      .then(d=>{
        let raw = (d.generated_note || "").trim();
        raw = raw.replace(/```(?:json)?\s*([\s\S]*?)\s*```/i,"$1").trim();
        const s = raw.indexOf("{"), e = raw.lastIndexOf("}");
        let jc = (s!==-1 && e!==-1) ? raw.slice(s,e+1) : raw;
        jc = jc.replace(/(\w+)\s*:/g,'"$1":').replace(/"\s+/g,'"')
               .replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"')
               .replace(/'/g,'"').replace(/,\s*([}\]])/g,"$1");

        try{ addAiMessage(JSON.parse(jc)); }
        catch(_){ addAiMessage(raw); }
      })
      .catch(err=>{
        addAiMessage(`<div style="color:#b00;">ì˜¤ë¥˜: ${String(err)}</div>`);
      })
      .finally(hideLoading);
    }

    function showLoading(){const o=document.getElementById("loading-overlay"); if(o) o.style.display="flex";}
    function hideLoading(){const o=document.getElementById("loading-overlay"); if(o) o.style.display="none";}
  </script>
</body>
</html>
